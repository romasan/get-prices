<html>
<head>
<script>
document.addEventListener("DOMContentLoaded", e => {
	var xhr = new XMLHttpRequest();
	xhr.open('GET', './data.json', true);
	xhr.send();
	xhr.onload = e => {
		let data = JSON.parse(xhr.responseText);
		// console.log(data);
		stat(data);
	}
});
let stat = e => {
	for(el of e.data) {
		// console.log(el);
		document.getElementById('area').innerHTML += `
		<div class="store">
			<div class="storename b">${el.name.toUpperCase()}</div>
			<div class="positions">
				${el.positions.map(pos => `
				<div class="position">
					<div class="name b">
						<a href="${pos.url}" target="_blank" title="record ID: ${pos.id}">
							${pos.name.replace(/\_/g, ' ')}
							<div class="hint">
								<canvas id="${addcanvas(pos)}"></canvas>
							</div>
						</a>
					</div>
					<div class="rows">
					${pos.rows.map((e, i, a) => `
						<span class="${i == 0 ? 'green' : a[i - 1].price > e.price ? 'green' : 'red'} b" title="${e.date.replace(/\_/g, ' ')}">${e.price}</span>
					`).join('\n')}
					</div>
				</div>
				`).join('\n')}
			</div>
		</div>`
	}
	gencanvases();
}
let canvases = [];
let addcanvas = data => {
	canvases.push(data)
	return 'canvas_' + canvases.length;
}
let gencanvases = e => {
	let width    = 600;// (window.innerWidth / 100 * 95) | 0,
	    height   = 160;
	for(i in canvases) {
		let minPrice = -1,
		    maxPrice = -1,
		    minDate  = -1,
		    maxDate  = -1;

		for(let row of canvases[i].rows) {
			
			let date = new Date(row.date.replace(/\_|\(|\)/g, ' ')).getTime();
			row._date = date;

			minDate = minDate > date || minDate < 0 ? date : minDate;
			maxDate = maxDate < date || maxDate < 0 ? date : maxDate;

			if(row.price != '') {
				minPrice = minPrice > row.price || minPrice < 0 ? row.price : minPrice;
				maxPrice = maxPrice < row.price || maxPrice < 0 ? row.price : maxPrice;
			}

			// canvases[i].minDate  = minDate;
			// canvases[i].maxDate  = maxDate;
			// canvases[i].minPrice = minPrice;
			// canvases[i].maxPrice = maxPrice;

			// if(minPrice == maxPrice) {
			// 	minPrice = 0;
			// }
		}		

		let _width = maxDate - minDate;

		let el = document.getElementById('canvas_' + ((i | 0) + 1));
		el.width = width;
		el.height = height;
		let ctx = el.getContext('2d');
		ctx.strokeStyle = '#0000ff';
		console.log('-----------', _width, maxPrice);
		for(let rowIndex in canvases[i].rows) {
			let row = canvases[i].rows[rowIndex];
			let x = (row._date - minDate) * (width / _width),
			    y = row.price * (height / maxPrice);
			console.log(x, y);
			if(rowIndex == 0) {
				ctx.moveTo(x, y);
			} else {
				ctx.lineTo(x, y);
			}
		}

		ctx.stroke();
	}
};
</script>
<style>
	.storename {
		text-align: center;
		font-size: 20pt;
		font-family: Arial;
	}
	.name a {
		color: black;
		text-decoration: none;
	}
	.name a:hover {
		color: blue;
		text-decoration: underline;
	}
	.name a .hint {
		display: none;
		position: absolute;
		background: #ffffff;
		border-radius: 5px;
		border: 1px solid #cccccc;
	}
	.name a:hover .hint {
		display: block;
	}
	.row {
		padding-bottom: 20px;
	}
	.b {
		font-weight: bold;
	}
	.green {
		color: green;
	}
	.red {
		color: red;
	}
</style>
</head>
<body>
	<div id="area"></div>
</body>
</html>
